<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otterbot - Legal AI Assistant</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .setup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .api-input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .legal-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .feature-card {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
        }
        .user-message {
            background: #e3f2fd;
            text-align: right;
        }
        .bot-message {
            background: #f1f8e9;
        }
        .legal-context {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        .message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .send-btn {
            padding: 12px 24px;
        }
        .document-upload {
            margin-bottom: 20px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
        }
        .uploaded-docs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .doc-tag {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¦¦ Otterbot - Legal AI Assistant</h1>
            <p>AI-powered legal document assistant with CourtListener integration</p>
        </div>

        <div class="setup-section">
            <h3>ðŸ”§ Setup Required:</h3>
            <div style="margin-bottom: 15px;">
                <input type="password" id="geminiApiKey" class="api-input" placeholder="Enter Gemini API Key" />
                <button class="btn" onclick="saveGeminiKey()">Save Gemini Key</button>
                <small>Get your free key at: <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
            </div>
            <div>
                <input type="password" id="courtListenerApiKey" class="api-input" placeholder="CourtListener API Key (Optional)" />
                <button class="btn btn-secondary" onclick="saveCourtListenerKey()">Save CourtListener Key</button>
                <small>Register at: <a href="https://www.courtlistener.com/api/" target="_blank">CourtListener API</a></small>
            </div>
        </div>

        <div class="legal-features">
            <div class="feature-card">
                <h4>ðŸ“š Legal Research Integration</h4>
                <p>Automatically searches CourtListener's database of legal opinions and precedents to inform responses</p>
            </div>
            <div class="feature-card">
                <h4>ðŸ“„ Document Analysis</h4>
                <p>Upload legal documents for context-aware assistance with drafting and analysis</p>
            </div>
        </div>

        <div class="document-upload">
            <h4>ðŸ“„ Upload Legal Documents for Reference</h4>
            <input type="file" id="fileInput" accept=".pdf,.txt,.doc,.docx" multiple style="margin-bottom: 10px;">
            <br>
            <button class="btn" onclick="uploadDocuments()">Upload Documents</button>
            <button class="btn btn-secondary" onclick="clearDocuments()">Clear All Documents</button>
            
            <div class="uploaded-docs" id="uploadedDocsList">
                <p>Uploaded Documents: <span id="docCount">0</span></p>
            </div>
        </div>

        <div id="statusMessage"></div>

        <div class="chat-container" id="chatContainer">
            <div class="message bot-message">
                <strong>Otterbot:</strong> Hello! I'm Otterbot, your legal AI assistant with access to CourtListener's legal database. I can help you draft legal documents, research case law, and provide legal guidance. Please set up your API keys above to get started!
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" class="message-input" placeholder="Ask me to help with legal documents, research case law, or draft agreements..." />
            <button class="btn send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Global variables
        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        let courtListenerApiKey = localStorage.getItem('courtListenerApiKey') || '';
        let uploadedDocuments = [];
        let conversationHistory = [];

        // CourtListener Service Class
        class CourtListenerService {
            constructor(apiKey = null) {
                this.baseUrl = 'https://www.courtlistener.com/api/rest/v4';
                this.apiKey = apiKey;
            }

            async searchCaseLaw(query, options = {}) {
                const params = new URLSearchParams({
                    q: query,
                    type: 'o',
                    order_by: 'score desc',
                    ...options
                });

                try {
                    const response = await fetch(`${this.baseUrl}/search/?${params}`, {
                        headers: this.apiKey ? {
                            'Authorization': `Token ${this.apiKey}`
                        } : {}
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('CourtListener search error:', error);
                    return null;
                }
            }

            extractLegalContext(searchResults) {
                if (!searchResults || !searchResults.results) {
                    return '';
                }

                const relevantCases = searchResults.results.slice(0, 3);
                
                return relevantCases.map(result => {
                    return `Case: ${result.caseName || 'N/A'}
Court: ${result.court || 'N/A'}
Date: ${result.dateFiled || 'N/A'}
Summary: ${result.snippet || 'N/A'}
---`;
                }).join('\n');
            }
        }

        // Initialize services
        const courtListener = new CourtListenerService(courtListenerApiKey);

        // API Key Management
        function saveGeminiKey() {
            const key = document.getElementById('geminiApiKey').value;
            if (key) {
                geminiApiKey = key;
                localStorage.setItem('geminiApiKey', key);
                showStatus('Gemini API key saved successfully!', 'success');
                document.getElementById('geminiApiKey').value = '';
            }
        }

        function saveCourtListenerKey() {
            const key = document.getElementById('courtListenerApiKey').value;
            if (key) {
                courtListenerApiKey = key;
                localStorage.setItem('courtListenerApiKey', key);
                courtListener.apiKey = key;
                showStatus('CourtListener API key saved successfully!', 'success');
                document.getElementById('courtListenerApiKey').value = '';
            }
        }

        // Document Management
        async function uploadDocuments() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            if (files.length === 0) {
                showStatus('Please select files to upload.', 'error');
                return;
            }

            for (let file of files) {
                try {
                    const text = await readFileAsText(file);
                    uploadedDocuments.push({
                        name: file.name,
                        content: text,
                        type: file.type,
                        size: file.size
                    });
                } catch (error) {
                    console.error('Error reading file:', error);
                    showStatus(`Error reading file: ${file.name}`, 'error');
                }
            }

            updateDocumentsList();
            showStatus(`${files.length} document(s) uploaded successfully!`, 'success');
            fileInput.value = '';
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        function clearDocuments() {
            uploadedDocuments = [];
            updateDocumentsList();
            showStatus('All documents cleared.', 'success');
        }

        function updateDocumentsList() {
            const docsList = document.getElementById('uploadedDocsList');
            const docCount = document.getElementById('docCount');
            
            docCount.textContent = uploadedDocuments.length;
            
            if (uploadedDocuments.length > 0) {
                const docTags = uploadedDocuments.map(doc => 
                    `<span class="doc-tag">${doc.name}</span>`
                ).join('');
                docsList.innerHTML = `<p>Uploaded Documents (${uploadedDocuments.length}):</p><div>${docTags}</div>`;
            } else {
                docsList.innerHTML = '<p>Uploaded Documents: 0</p>';
            }
        }

        // Chat Functionality
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;
            if (!geminiApiKey) {
                showStatus('Please set up your Gemini API key first.', 'error');
                return;
            }

            // Add user message to chat
            addMessageToChat(message, 'user');
            messageInput.value = '';

            try {
                // Show loading
                const loadingElement = addMessageToChat('Searching legal database and generating response...', 'bot');
                
                const response = await processLegalQuery(message, uploadedDocuments);
                
                // Remove loading message
                loadingElement.remove();
                
                // Add bot response
                addMessageToChat(response, 'bot');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('Error processing your message. Please try again.', 'error');
            }
        }

        async function processLegalQuery(userMessage, uploadedDocs = []) {
            // Analyze query and search for legal context
            const legalContext = await searchLegalContext(userMessage);
            
            // Build enhanced prompt
            const enhancedPrompt = buildEnhancedPrompt(userMessage, legalContext, uploadedDocs);
            
            // Send to Gemini API
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: enhancedPrompt
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API error: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function searchLegalContext(query) {
            try {
                // Extract legal keywords for search
                const legalKeywords = extractLegalKeywords(query);
                const searchResults = await courtListener.searchCaseLaw(legalKeywords);
                return courtListener.extractLegalContext(searchResults);
            } catch (error) {
                console.error('Legal search error:', error);
                return '';
            }
        }

        function extractLegalKeywords(text) {
            const keywords = text.match(/\b(contract|agreement|liability|damages|jurisdiction|breach|terms|conditions|dispute|arbitration|negotiation|business|client|draft|legal)\b/gi);
            return keywords ? keywords.join(' ') : text;
        }

        function buildEnhancedPrompt(userMessage, legalContext, uploadedDocs) {
            return `You are Otterbot, a legal AI assistant specialized in helping legal professionals draft documents and provide legal guidance.

USER REQUEST: ${userMessage}

LEGAL PRECEDENTS AND CONTEXT:
${legalContext || 'No specific legal precedents found for this query.'}

UPLOADED DOCUMENTS CONTEXT:
${uploadedDocs.map(doc => `Document: ${doc.name}\nContent: ${doc.content?.substring(0, 500)}...`).join('\n\n') || 'No documents uploaded.'}

INSTRUCTIONS:
1. Use the legal precedents above to inform your response with proper legal language and structure
2. Reference relevant case law where appropriate
3. Ensure compliance with standard legal document formatting
4. Include necessary legal disclaimers
5. Provide practical, actionable guidance

Please provide a comprehensive response that incorporates the legal context provided above.`;
        }

        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                messageDiv.innerHTML = `<strong>Otterbot:</strong> ${message}`;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageDiv;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (geminiApiKey) {
                showStatus('Gemini API key loaded from storage.', 'success');
            }
            if (courtListenerApiKey) {
                showStatus('CourtListener API key loaded from storage.', 'success');
            }
        });
    </script>
</body>
</html>
